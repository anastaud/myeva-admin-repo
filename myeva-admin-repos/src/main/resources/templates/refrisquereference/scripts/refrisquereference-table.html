<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
	<div th:fragment="refrisquereferenceTableJsFragment">

		<!-- ATTENTION: mettre obligatoirement le javascript à l'intérieur de la section du template et utiliser th:inline pour interpréter les variable Model -->
		<script th:inline="javascript">
	
				// Fonction de convertion d'une table en arbre Tabulator
			function treefy(refrisques) {
				
				// Récuparation de l'état d'expansion des noeuds
				const expandeds=getExpandeds();
								
				// Conversion en arborescence Tabulator
				var nodeIndex = 1;
				var _refrisques=[];							
				if (refrisques!=null) for(var j= 0; j < refrisques.length; j++) {	
						
						var refrisque=refrisques[j];
						var childs=[];								
						var refConditionExpositions=refrisque["conditions"];
						var refMesurePreventions=refrisque["mesures"]; 
						var refActions=refrisque["actions"];
						
						if (refConditionExpositions!=null) for(var k= 0; k < refConditionExpositions.length; k++) {
							var refConditionExposition=refConditionExpositions[k];
							childs.push({
								"parent": refrisque["id"]
								,"parentLabel": refrisque["label"]
								,"parentType": 'risque'
								,"id": refConditionExposition["id"]	
								,"type": 'condition'
								,"typeLabel": /*[[#{refrisquereferences.label.type.condition}]]*/ "Condition d'exposition"
								,"label": refConditionExposition["label"]
								,"description": refConditionExposition["description"]
								,"isEnabled": refConditionExposition["isEnabled"]
								,"isUsed": refConditionExposition["isUsed"]
								,"creationDate": refConditionExposition["creationDate"]
								,"updateDate": refConditionExposition["updateDate"]
							
								,"nodeIndex":nodeIndex++
							});						
						}		
						
						if (refMesurePreventions!=null) for(var k= 0; k < refMesurePreventions.length; k++) {
							var refMesurePrevention=refMesurePreventions[k];
							childs.push({
								"parent": refrisque["id"]
								,"parentLabel": refrisque["label"]
								,"parentType": 'risque'
								,"id": refMesurePrevention["id"]	
								,"type": 'mesure'
								,"typeLabel":/*[[#{refrisquereferences.label.type.mesure}]]*/ "Mesure de prévention"
								,"label": refMesurePrevention["label"]
								,"description": refMesurePrevention["description"]
								,"isUsed": refMesurePrevention["isUsed"]
								,"creationDate": refMesurePrevention["creationDate"]
								,"updateDate": refMesurePrevention["updateDate"]
							
								,"nodeIndex":nodeIndex++
							});
						}
	
						if (refActions!=null) for(var k= 0; k < refActions.length; k++) {
							var refAction=refActions[k];
							childs.push({
								"parent": refrisque["id"]
								,"parentLabel": refrisque["label"]
								,"parentType": 'risque'
								,"id": refAction["id"]	
								,"type": 'action'
								,"typeLabel":/*[[#{refrisquereferences.label.type.action}]]*/ "Action"
								,"label": refAction["label"]
								,"description": refAction["description"]
								,"isEnabled": refAction["isEnabled"]
								,"isUsed": refAction["isUsed"]
								,"creationDate": refAction["creationDate"]
								,"updateDate": refAction["updateDate"]
							
								,"nodeIndex":nodeIndex++
							});
						}
													
						_refrisques.push({
							"id": refrisque["id"]	
							,"seq": refrisque["seq"]	
							,"type": "risque"
							,"typeLabel":/*[[#{refrisquereferences.label.type.risque}]]*/ "Risque"
							,"label": refrisque["label"]
							,"description": refrisque["description"]
							,"isEnabled": refrisque["isEnabled"]
							,"isUsed": refrisque["isUsed"]
							,"creationDate": refrisque["creationDate"]
							,"updateDate": refrisque["updateDate"]							
							,"nodeIndex":nodeIndex++
							,"isComplete": refMesurePreventions!=null && refMesurePreventions.length>0
										   && refConditionExpositions !=null && refConditionExpositions.length>0
										   
							,"isExpanded": expandeds.has("risque_"+refrisque["id"])
							
							,"_children": childs
						});	
											
				}					
				return _refrisques;
			}
								
			function scrollToRow(treeTable,id) {
			    var rows = treeTable.searchRows("id", "=", parseInt(id));
			    treeTable.scrollToRow(rows[0], "middle");	
			}
			
			var treeTable = new Tabulator("#treeTable", {
			    theme: "bootstrap5"
			    ,rowHeight:25
			    ,layout: "fitColumns",responsiveLayout:"hide" // ATTENTION: ces deux options sont importantes ensembles pour le responsive et la répartition de colonnes
			    //autoResize:false, // ATTENTION: cette option annule le responsive
			    ,placeholder: /*[[#{message.noData}]]*/ "Aucune donnée"
			    ,index:"nodeIndex" 
			    ,data: treefy(getRefRisqueReferences())	    
			    ,dataTree: true	    
			    ,dataTreeChildColumnCalcs:true
			    ,dataTreeStartExpanded: false
			    ,dataTreeElementColumn:"label" // colonne qui sert de noeud expand/collapse
			    ,dataTreeChildIndent:30 //indentation des fils en px  			    
				/*,dataTreeExpandElement: "<i class='fa-regular fa-square-plus' style='margin-right:8px;'></i>"
				,dataTreeCollapseElement: "<i class='fa-regular fa-square-minus' style='margin-right:8px;'></i>"*/				
				,dataTreeExpandElement: "<i class='fa-regular fa-folder' style='margin-right:8px;'></i>"
				,dataTreeCollapseElement: "<i class='fa-regular fa-folder-open' style='margin-right:8px;'></i>"				
			    ,dataTreeStartExpanded: function(row, level){ return row.getData().isExpanded; }	       
			    ,rowFormatter: rowFormatter
			    ,rowContextMenu: displayContexteMenu	
			    ,columns:[{
			        /*    title:"id"
			            ,field:"id"
			            ,width: 100
			            ,visible:false
			        },{*/
			            title: /*[[#{refrisquereferences.label.label}]]*/ "Libellé"
			            ,field:"label"
			            ,headerSort:false
			            ,responsive:0 //ne sera jamais masquée
			            //,widthGrow:9
			            ,formatter:labelFormatter
			        //},{
			         //   title: /*[[#{refrisquereferences.label.seq}]]*/ "Ordre"
			           // ,field:"seq"
			           // ,headerSort:false	    			
			           // ,hozAlign:"left" ,vertAlign:"middle"
			           // ,widthGrow:1
			    }]
			});
			
			function labelFormatter(cell, formatterParams, onRendered){
				const data=cell.getRow().getData();
			    return  data["type"] == "risque" ? data["seq"]+"&nbsp;-&nbsp;"+data["label"]:data["label"];
			}
			
			function rowFormatter(row){
			    var data = row.getData();
				if (data["type"]=="risque") {
			        //row.getElement().style.backgroundColor = data.color;
			        row.getElement().style.color = "blue";//"#6B88C7";
			    }
			    else if (data["type"]=="condition") {
			        //row.getElement().style.backgroundColor = data.color;
			        row.getElement().style.color = "red";//"#F1948A";
			    }
			    else  if(data["type"]=="mesure") {
			        row.getElement().style.color = "green";//#7DCEA0";
			    }
			    else  if(data["type"]=="action") {
			        row.getElement().style.color = "#2E86C1";
			    }
			}  
			
			function displayContexteMenu(event, component) {
				const data=component.getData();
				return 	data["type"]=="risque" ? displayRisqueContexteMenu(event, component)
						:data["type"]=="condition" ? displayConditionContexteMenu(event, component)
						:data["type"]=="mesure" ? displayMesureContexteMenu(event, component)
						:null;
			}
			
			function displayRisqueContexteMenu(event, component) {
				return [{
				            label:"<i class='fa fa-trash'></i>&nbsp;"+ "Supprimer le risque"
			            ,action:function(event, column){ 
			                displayDeleteRefRisqueReferenceModal(component.getData(),function(){
			                    component.delete();
			                });	    
			            }
			        }, {
			            separator:true,    	
			        }, {
			            label:"<i class='fa fa-plus'></i>&nbsp;"+  "Ajouter une condition d'exposition"
			            ,action:function(event, column){ 			                
		                    displayAddLeafModal("Ajout d'une condition d'exposition","condition",component.getData());		                
			            }
			        }, {
			            label:"<i class='fa fa-plus'></i>&nbsp;"+  "Ajouter une mesure de prévention"
			            ,action:function(event, column){ 			                
		                    displayAddLeafModal("Ajout d'une mesure de prévention","mesure",component.getData());		                
			            }
			        }				
				];
			}
			
			function displayConditionContexteMenu(event, component) {
				return [{
				        label:"<i class='fa fa-trash'></i>&nbsp;"+ "Supprimer la condition d'exposition"
			            ,action:function(event, column){ 
							const data =component.getData();
							openPageSpinner();
			                deleteRefLeaf("condition",data["id"],function(){
								component.delete();
								closePageSpinner();			                    
			                    displaySuccess(/*[[#{refposte.message.risques.condition.delete.acknowledgment}]]*/ "Condition supprimée avec succès");
			                });
			            }
			    }];
			}
			
			function displayMesureContexteMenu(event, component) {
				return [{
				        label:"<i class='fa fa-trash'></i>&nbsp;"+ "Supprimer la mesure de prévention"
			            ,action:function(event, column){ 
							const data =component.getData();
							openPageSpinner();
			                deleteRefLeaf("mesure",data["id"],function(){
								component.delete();
								closePageSpinner();			                    
			                    displaySuccess(/*[[#{refposte.message.risques.mesure.delete.acknowledgment}]]*/ "Mesure supprimée avec succès");
			                });
			            }
			    }];
			}
						
			treeTable.on("dataTreeRowExpanded", function(row, level){		
				const data = row.getData();
				setNodeExpanded(getNodeKey(data)); 
			});
			
			treeTable.on("dataTreeRowCollapsed", function(row, level){
				const data = row.getData();
				setNodeCollapsed(getNodeKey(data)); 
			});	

		    $('#refreshButton').on('click', function(e) {
		        e.preventDefault();
		        if($(this).data('page') === 'refpostes') {
		            treeTable.replaceData(treefy(getRefRisqueReferences()));
		        } 
		    });		
	
		</script>
	</div>
</body>
</html>